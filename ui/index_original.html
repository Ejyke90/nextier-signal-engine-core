<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nextier Signal Engine - Nigeria Conflict Risk Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 500px; }
        .risk-critical { background-color: #dc2626; }
        .risk-high { background-color: #ea580c; }
        .risk-medium { background-color: #ca8a04; }
        .risk-low { background-color: #65a30d; }
        .risk-minimal { background-color: #16a34a; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-blue-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <h1 class="text-2xl font-bold">Nextier Signal Engine</h1>
                </div>
                <div class="text-sm">
                    Nigeria Conflict Risk Monitor
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Raw Articles</p>
                        <p class="text-2xl font-bold text-blue-600" id="raw-articles-count">-</p>
                    </div>
                    <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                    </svg>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Parsed Events</p>
                        <p class="text-2xl font-bold text-green-600" id="parsed-events-count">-</p>
                    </div>
                    <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Risk Signals</p>
                        <p class="text-2xl font-bold text-orange-600" id="risk-signals-count">-</p>
                    </div>
                    <svg class="w-8 h-8 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">High Risk Areas</p>
                        <p class="text-2xl font-bold text-red-600" id="high-risk-count">-</p>
                    </div>
                    <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <button onclick="triggerScraping()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>Scrape News</span>
                </button>
                
                <button onclick="triggerAnalysis()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span>Analyze Events</span>
                </button>
                
                <button onclick="triggerPrediction()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span>Calculate Risks</span>
n                <button onclick="openStressTest()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Stress Test</span>
                </button>
                </button>
                
                <button onclick="refreshData()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>Refresh</span>
                </button>
            </div>
        </div>

        <!-- Map and Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Nigeria Map -->
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="text-xl font-bold mb-4">Nigeria Risk Heatmap</h2>
                <div id="map"></div>
            </div>
            
            <!-- Risk Distribution Chart -->
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="text-xl font-bold mb-4">Risk Level Distribution</h2>
                <canvas id="riskChart"></canvas>
            </div>
        </div>

        <!-- Recent Events Table -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-xl font-bold mb-4">Recent Risk Signals</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk Score</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Economic Factors</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                        </tr>
                    </thead>
                    <tbody id="events-table" class="bg-white divide-y divide-gray-200">
                        <!-- Events will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // API endpoints
        const API_BASE = '';
        const SCRAPER_API = 'http://localhost:8000';
        const INTELLIGENCE_API = 'http://localhost:8001';
        const PREDICTOR_API = 'http://localhost:8002';

        // Global variables
        let map;
        let riskChart;
        let markers = [];

        // Initialize map
        function initMap() {
            map = L.map('map').setView([9.0820, 8.6753], 6); // Center of Nigeria
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Initialize risk chart
        function initRiskChart() {
            const ctx = document.getElementById('riskChart').getContext('2d');
            riskChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low', 'Minimal'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#dc2626', '#ea580c', '#ca8a04', '#65a30d', '#16a34a'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // API call helper
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                showNotification('API call failed: ' + error.message, 'error');
                return null;
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const colors = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // Trigger scraping
        async function triggerScraping() {
            showNotification('Starting news scraping...', 'info');
            const result = await apiCall(`${SCRAPER_API}/api/v1/scrape`, { method: "POST" });
            if (result) {
                showNotification(`${result.message}`, 'success');
                setTimeout(refreshData, 2000);
            }
        }

        // Trigger analysis
        async function triggerAnalysis() {
            showNotification('Starting event analysis...', 'info');
            const result = await apiCall(`${INTELLIGENCE_API}/api/v1/analyze`, { method: "POST" });
            if (result) {
                showNotification('Analysis started', 'success');
                setTimeout(refreshData, 5000);
            }
        }

        // Trigger prediction
        async function triggerPrediction() {
            showNotification('Calculating risk scores...', 'info');
            const result = await apiCall(`${PREDICTOR_API}/api/v1/predict`, { method: "POST" });
            if (result) {
                showNotification('Risk calculation started', 'success');
                setTimeout(refreshData, 5000);
            }
        }

        // Refresh all data
        async function refreshData() {
            await Promise.all([
                updateStatusCards(),
                updateRiskSignals(),
                updateMap(),
                updateChart()
            ]);
        }

        // Update status cards
        async function updateStatusCards() {
            try {
                const [scraperStatus, intelStatus, predictorStatus] = await Promise.all([
                    apiCall(`${SCRAPER_API}/api/v1/articles`),
                    apiCall(`${INTELLIGENCE_API}/api/v1/status`),
                    apiCall(`${PREDICTOR_API}/api/v1/status`)
                ]);

                if (scraperStatus) {
                    document.getElementById('raw-articles-count').textContent = scraperStatus.count || 0;
                }
                if (intelStatus) {
                    document.getElementById('parsed-events-count').textContent = intelStatus.parsed_events_count || 0;
                }
                if (predictorStatus) {
                    document.getElementById('risk-signals-count').textContent = predictorStatus.risk_signals_count || 0;
                }

                // Update high risk count
                const signals = await apiCall(`${PREDICTOR_API}/api/v1/signals`);
                if (signals && signals.signals) {
                    const highRiskCount = signals.signals.filter(s => 
                        s.risk_level === 'Critical' || s.risk_level === 'High'
                    ).length;
                    document.getElementById('high-risk-count').textContent = highRiskCount;
                }
            } catch (error) {
                console.error('Error updating status cards:', error);
            }
        }

        // Update risk signals table
        async function updateRiskSignals() {
            const signals = await apiCall(`${PREDICTOR_API}/api/v1/signals`);
            if (!signals || !signals.signals) return;

            const tbody = document.getElementById('events-table');
            tbody.innerHTML = '';

            signals.signals.slice(0, 10).forEach(signal => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const riskColor = {
                    'Critical': 'text-red-600 font-bold',
                    'High': 'text-orange-600 font-semibold',
                    'Medium': 'text-yellow-600',
                    'Low': 'text-green-600',
                    'Minimal': 'text-blue-600'
                }[signal.risk_level] || 'text-gray-600';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${signal.event_type}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${signal.state}, ${signal.lga}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${signal.severity}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="${riskColor}">${signal.risk_score} - ${signal.risk_level}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        Fuel: ₦${signal.fuel_price} | Inflation: ${signal.inflation}%
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(signal.calculated_at).toLocaleString()}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update map with risk markers
        async function updateMap() {
            const signals = await apiCall(`${PREDICTOR_API}/api/v1/signals`);
            if (!signals || !signals.signals) return;

            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            markers = [];

            // Simple coordinates for Nigerian states (approximate)
            const stateCoordinates = {
                'Lagos': [6.5244, 3.3792],
                'Abuja': [9.0765, 7.3986],
                'Kano': [11.9804, 8.5216],
                'Rivers': [4.8156, 7.0498],
                'unknown': [9.0820, 8.6753] // Center of Nigeria
            };

            signals.signals.forEach(signal => {
                const coords = stateCoordinates[signal.state] || stateCoordinates['unknown'];
                
                const color = {
                    'Critical': '#dc2626',
                    'High': '#ea580c',
                    'Medium': '#ca8a04',
                    'Low': '#65a30d',
                    'Minimal': '#16a34a'
                }[signal.risk_level] || '#6b7280';

                const marker = L.circleMarker(coords, {
                    radius: Math.max(5, signal.risk_score / 10),
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.7
                }).addTo(map);

                marker.bindPopup(`
                    <strong>${signal.event_type}</strong><br>
                    ${signal.state}, ${signal.lga}<br>
                    Risk Score: ${signal.risk_score}<br>
                    Severity: ${signal.severity}<br>
                    Fuel: ₦${signal.fuel_price} | Inflation: ${signal.inflation}%
                `);

                markers.push(marker);
            });
        }

        // Update risk distribution chart
        async function updateChart() {
            const signals = await apiCall(`${PREDICTOR_API}/api/v1/signals`);
            if (!signals || !signals.signals) return;

            const distribution = {
                'Critical': 0,
                'High': 0,
                'Medium': 0,
                'Low': 0,
                'Minimal': 0
            };

            signals.signals.forEach(signal => {
                if (distribution.hasOwnProperty(signal.risk_level)) {
                    distribution[signal.risk_level]++;
                }
            });

            riskChart.data.datasets[0].data = Object.values(distribution);
            riskChart.update();
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initRiskChart();
            refreshData();
n        // Real-time monitoring with enhanced polling
        let lastSignalCount = 0;
        let pulseAnimation = false;
        
        // Enhanced refresh with pulse detection
        async function enhancedRefresh() {
            const signals = await apiCall(`${PREDICTOR_API}/api/v1/signals`);
            if (signals && signals.signals) {
                const currentCount = signals.signals.length;
                if (currentCount > lastSignalCount && lastSignalCount > 0) {
                    triggerMapPulse();
                    showNotification(`New risk signal detected! Total: ${currentCount}`, "warning");
                }
                lastSignalCount = currentCount;
            }
            await refreshData();
        }
        
        // Map pulse animation
        function triggerMapPulse() {
            const mapContainer = document.getElementById("map");
            if (mapContainer && !pulseAnimation) {
                pulseAnimation = true;
                mapContainer.style.animation = "pulse 2s ease-in-out 3";
                setTimeout(() => {
                    mapContainer.style.animation = "";
                    pulseAnimation = false;
                }, 6000);
            }
        }
            
            // Auto-refresh every 30 seconds
            setInterval(enhancedRefresh, 5000); // Real-time monitoring every 5 seconds
        });
    </script>
n        <!-- Stress Test Injector Modal -->
        <div id="stressTestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                    <h3 class="text-lg font-bold mb-4">Economic Stress Test</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Fuel Price (NGN)</label>
                            <input type="number" id="fuelPrice" class="w-full border rounded px-3 py-2" value="650" min="400" max="2000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Inflation Rate (%)</label>
                            <input type="number" id="inflationRate" class="w-full border rounded px-3 py-2" value="25" min="10" max="50" step="0.1">
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="applyStressTest()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded flex-1">Apply Test</button>
                            <button onclick="closeStressTest()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded flex-1">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</body>
</html>
